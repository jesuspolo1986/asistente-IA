<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Elena AI | Farmacia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #00d2ff; --bg: #0f172a; --warning: #f39c12; }
        body { background: var(--bg); color: white; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: sans-serif; }
        
        .grace-banner { background: var(--warning); color: black; width: 100%; position: fixed; top: 0; padding: 10px; text-align: center; font-weight: bold; z-index: 9999; }
        
        .card-elena, .login-card { background: rgba(255,255,255,0.05); padding: 2rem; border-radius: 30px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); width: 400px; text-align: center; }
        
        .aura { width: 100px; height: 100px; margin: 0 auto 1.5rem; border-radius: 50%; background: linear-gradient(45deg, var(--primary), #3a7bd5); animation: pulse 2s infinite; cursor: pointer; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0,210,255,0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(0,210,255,0); } 100% { transform: scale(1); } }
        
        .res-box { min-height: 80px; margin-bottom: 20px; font-size: 1.1rem; color: #cbd5e1; }
        .input-elena { background: rgba(255,255,255,0.1); border: none; border-radius: 10px; color: white; padding: 12px; width: 100%; text-align: center; }
    </style>
</head>
<body>

    {% if dias_restantes == 0 %}
    <div class="grace-banner">‚ö†Ô∏è Tu suscripci√≥n vence hoy. ¬°Recuerda renovar!</div>
    {% elif dias_restantes < 0 %}
    <div class="grace-banner">üö® Suscripci√≥n vencida ayer. Est√°s en tu d√≠a de gracia.</div>
    {% endif %}

    {% if not session.get('autenticado') %}
    <div class="login-card">
        <h3 class="mb-4">Elena AI</h3>
        <form action="/login" method="POST">
            <input type="email" name="email" class="form-control mb-3 bg-dark text-white border-0" placeholder="Correo" required>
            <input type="password" name="password" class="form-control mb-3 bg-dark text-white border-0" placeholder="Contrase√±a" required>
            <button type="submit" class="btn btn-primary w-100 fw-bold">ENTRAR AL SISTEMA</button>
        </form>
    </div>
    {% else %}
    <div class="card-elena">
        <div class="d-flex justify-content-between mb-3 small opacity-75">
            <span>TASA BCV: <b>{{ tasa }}</b></span>
            <a href="/logout" class="text-danger text-decoration-none">Salir</a>
        </div>
        <div class="aura" onclick="escuchar()"></div>
        <div id="textoElena" class="res-box">Toca el c√≠rculo para consultar precio...</div>
        <input type="text" id="userInput" class="input-elena" placeholder="Nombre del producto..." onkeypress="if(event.key==='Enter') enviar()">
    </div>
    {% endif %}

    <script>
        const synth = window.speechSynthesis;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        function hablar(t) {
            synth.cancel();
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'es-MX';
            synth.speak(u);
        }

        function escuchar() {
            const rec = new SpeechRecognition();
            rec.lang = 'es-VE';
            rec.onresult = (e) => {
                document.getElementById('userInput').value = e.results[0][0].transcript;
                enviar();
            };
            rec.start();
        }

        async function enviar() {
            const q = document.getElementById('userInput').value;
            const res = await fetch('/preguntar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ pregunta: q })
            });
            const data = await res.json();
            document.getElementById('textoElena').innerText = data.respuesta;
            hablar(data.respuesta);
            document.getElementById('userInput').value = "";
        }
    </script>
</body>
</html>