<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pro Analyst | Business Intelligence</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --danger: #ef4444; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: #1e293b; }
        
        header { background: var(--primary); color: white; padding: 0 2rem; display: flex; align-items: center; height: 50px; position: sticky; top: 0; z-index: 100; }
        
        /* DISEÑO DE GRILLA (PC) */
        .main-grid { display: grid; grid-template-columns: 320px 1fr; height: calc(100vh - 50px); }
        
        .sidebar { background: white; border-right: 1px solid #e2e8f0; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        
        #chart-container-sidebar { margin-top: 15px; padding-top: 15px; border-top: 1px solid #f1f5f9; display: none; flex-direction: column; gap: 10px; }
        
        .chat-area { display: flex; flex-direction: column; background: var(--bg); overflow: hidden; height: 100%; }
        
        #output { flex-grow: 1; overflow-y: auto; padding: 25px 8%; scroll-behavior: smooth; }
        
        .message { margin-bottom: 25px; line-height: 1.6; animation: fadeIn 0.3s ease; }
        .ai-msg { color: #334155; font-size: 1rem; }
        .user-msg { background: #3b82f6; color: white; padding: 12px 20px; border-radius: 15px 15px 0 15px; width: fit-content; max-width: 85%; margin-left: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .input-wrapper { background: white; padding: 15px 8%; border-top: 1px solid #e2e8f0; }
        .input-group { display: flex; gap: 10px; align-items: center; background: #f1f5f9; padding: 8px 15px; border-radius: 25px; }
        textarea { flex-grow: 1; border: none; background: transparent; outline: none; resize: none; font-size: 1rem; padding: 8px; font-family: inherit; max-height: 150px; }
        
        button { cursor: pointer; border: none; border-radius: 8px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; padding: 12px; width: 100%; font-weight: 600; }
        .btn-send { background: var(--accent); color: white; width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; }

        /* SECCIÓN DE FIRMA PROFESIONAL */
        .sidebar-footer {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid #f1f5f9;
            font-size: 0.75rem;
            color: #64748b;
        }
        .dev-name { color: var(--primary); font-weight: 700; display: block; margin-top: 2px; }
        .powered-by { font-style: italic; display: flex; align-items: center; gap: 4px; margin-top: 4px; }
        .location { margin-top: 6px; display: flex; align-items: center; gap: 5px; opacity: 0.8; }

        /* TABLAS RESPONSIVE */
        .table-container { width: 100%; overflow-x: auto; margin: 20px 0; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        table { border-collapse: collapse; width: 100%; background: white; min-width: 500px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #f1f5f9; }
        th { background: #f8fafc; font-weight: 700; color: #475569; }

        /* --- MEDIA QUERY PARA MÓVILES --- */
        @media (max-width: 850px) {
            .main-grid { grid-template-columns: 1fr; height: auto; display: block; }
            .sidebar { border-right: none; border-bottom: 1px solid #e2e8f0; width: 100%; box-sizing: border-box; min-height: auto; }
            .sidebar-footer { margin-top: 20px; padding-bottom: 10px; }
            .chat-area { height: 70vh; }
            #output { padding: 20px 5%; }
            .input-wrapper { padding: 10px 5%; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <h3><i class="fas fa-brain"></i> AI Pro Analyst</h3>
</header>

<div class="main-grid">
    <div class="sidebar">
        <div>
            <h4 style="margin: 0 0 15px 0;">Panel de Control</h4>
            <form id="upload-form">
                <input type="file" name="file" id="file-input" style="font-size: 0.8rem; width: 100%; margin-bottom: 12px;" required>
                <button type="submit" id="upload-btn" class="btn-primary">Procesar Datos</button>
            </form>
            <button onclick="newSession()" style="background:none; border: 1px solid #cbd5e1; color:#64748b; width:100%; padding:8px; margin-top:10px; border-radius:8px; font-size:0.8rem;">
                <i class="fas fa-redo"></i> Nueva Sesión
            </button>
        </div>

        <div id="chart-container-sidebar">
            <span style="font-size: 0.7rem; font-weight: 800; color: #94a3b8; text-transform: uppercase;">Gráfico de Apoyo</span>
            <div style="height: 180px;"><canvas id="salesChart"></canvas></div>
        </div>

        <div class="sidebar-footer">
            <span>Desarrollado por:</span>
            <span class="dev-name">Jesus M Polo</span>
            <span class="powered-by">Powered by <i class="fas fa-bolt" style="color: #fbbf24;"></i> <strong>MISTRAL</strong></span>
            <div class="location">
                <i class="fas fa-location-dot"></i> Guanare - Venezuela
            </div>
        </div>
    </div>

    <div class="chat-area">
        <div id="output">
            <div class="message ai-msg">
                <h2>Centro de Análisis Listo</h2>
                <p>Las tablas y reportes se optimizarán automáticamente para su pantalla.</p>
            </div>
        </div>
        
        <div class="input-wrapper">
            <form id="chat-form" class="input-group">
                <textarea id="question" rows="1" placeholder="Escriba su consulta..." required></textarea>
                <button type="submit" class="btn-send"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>
</div>

<script>
    let myChart = null;
    const output = document.getElementById('output');
    const chartSidebar = document.getElementById('chart-container-sidebar');

    function renderChart(chartData) {
        const ctx = document.getElementById('salesChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [{ data: chartData.values, backgroundColor: '#3b82f6', borderRadius: 4 }]
            },
            options: {
                indexAxis: 'y',
                maintainAspectRatio: false,
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { ticks: { font: { size: 10 } } } }
            }
        });
    }

    function newSession() {
        location.reload();
    }

    document.getElementById('upload-form').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('upload-btn');
        btn.innerHTML = 'Procesando...';
        const res = await fetch('/upload', { method: 'POST', body: new FormData(e.target) });
        const data = await res.json();
        output.innerHTML += `<div class="message ai-msg"><strong>Sistema:</strong> ${data.reply}</div>`;
        if(data.chart_data) {
            chartSidebar.style.display = 'flex';
            renderChart(data.chart_data);
        }
        btn.innerHTML = 'Procesar Datos';
        output.scrollTop = output.scrollHeight;
    };

    document.getElementById('chat-form').onsubmit = async (e) => {
        e.preventDefault();
        const qField = document.getElementById('question');
        const question = qField.value;
        output.innerHTML += `<div class="message user-msg">${question}</div>`;
        qField.value = "";

        const res = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: question })
        });
        const data = await res.json();
        
        let htmlResponse = marked.parse(data.reply);
        htmlResponse = htmlResponse.replace(/<table>/g, '<div class="table-container"><table>').replace(/<\/table>/g, '</table></div>');
        
        output.innerHTML += `<div class="message ai-msg">${htmlResponse}</div>`;
        if(data.new_chart_data) {
            chartSidebar.style.display = 'flex';
            renderChart(data.new_chart_data);
        }
        output.scrollTop = output.scrollHeight;
    };
</script>
</body>
</html>