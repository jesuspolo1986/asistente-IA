<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pro Analyst - Control Panel</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --accent: #3b82f6; --dark: #0f172a; --bg: #f8fafc; --success: #10b981; --danger: #ef4444; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 280px; background: white; border-right: 1px solid #e2e8f0; padding: 20px; display: flex; flex-direction: column; z-index: 10; }
        .status-card { background: #f1f5f9; padding: 15px; border-radius: 12px; margin-top: 20px; font-size: 0.85rem; }
        .progress-bar { background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-fill { background: var(--accent); height: 100%; transition: width 0.5s; width: 0%; }
        
        #auth-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: white; padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; }

        .main { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow: hidden; }
        #chat-window { flex: 1; background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { padding: 14px; border-radius: 12px; max-width: 85%; line-height: 1.5; font-size: 0.95rem; }
        .msg-user { align-self: flex-end; background: var(--dark); color: white; margin-left: auto; border-bottom-right-radius: 2px; }
        .msg-ai { align-self: flex-start; background: #f1f5f9; border: 1px solid #e2e8f0; border-bottom-left-radius: 2px; }
        
        .input-area { display: flex; gap: 10px; background: white; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-top: 15px; }
        input[type="text"] { flex: 1; border: none; outline: none; font-size: 1rem; }
        
        .btn-pdf { background: var(--danger); color: white; padding: 10px 18px; display: none; margin-bottom: 12px; align-self: flex-end; cursor: pointer; border: none; border-radius: 8px; font-weight: 600; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-box">
        <i class="fas fa-brain" style="font-size: 3rem; color: var(--accent); margin-bottom: 10px;"></i>
        <h2>AI Pro Analyst</h2>
        <form id="auth-form">
            <input type="email" id="auth-email" class="auth-input" style="width:100%; padding:12px; margin:10px 0;" placeholder="Correo" required>
            <input type="password" id="auth-password" class="auth-input" style="width:100%; padding:12px; margin:10px 0;" placeholder="Contraseña" required>
            <button type="submit" style="width:100%; background:var(--dark); color:white; padding:14px; cursor:pointer; border:none; border-radius:8px;">Iniciar Sesión</button>
        </form>
    </div>
</div>

<div class="sidebar">
    <h2><i class="fas fa-chart-line"></i> Dashboard</h2>
    <div class="status-card">
        <div style="display:flex; justify-content:space-between;"><span>Días:</span> <strong id="dias-val">0/7</strong></div>
        <div class="progress-bar"><div id="barra-dias" class="progress-fill"></div></div>
        <p id="info-consultas">Consultas: 0/10</p>
    </div>
    <div style="margin-top:auto; padding-top:20px; border-top:1px solid #eee;">
        <span id="user-display" style="font-size:0.8rem;"></span><br>
        <button onclick="cerrarSesion()" style="color:var(--danger); background:none; border:none; cursor:pointer;">Cerrar Sesión</button>
    </div>
</div>

<div class="main">
    <button id="download-pdf" class="btn-pdf"><i class="fas fa-file-pdf"></i> Descargar Reporte Completo</button>
    <div id="chat-window">
        <div id="upload-zone" style="text-align:center; border:2px dashed #ccc; padding:30px; cursor:pointer;" onclick="document.getElementById('file-in').click()">
            <i class="fas fa-cloud-upload-alt" style="font-size:2rem;"></i><p>Subir Excel o CSV</p>
        </div>
        <input type="file" id="file-in" style="display:none" onchange="subirArchivo(this)">
    </div>
    <form id="chat-form" class="input-area">
        <input type="text" id="user-input" placeholder="Pregunta algo...">
        <button type="submit" style="background:var(--dark); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
    </form>
</div>

<script>
    const supabaseUrl = 'https://kebpamfydhnxeaeegulx.supabase.co';
    const supabaseKey = 'sb_publishable_4MfYQjPVzSmLoEqp4XiVOQ_qjkjEpKi';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    let currentUser = null;

    async function actualizarUI(user) {
        if (!user) return;
        currentUser = user;
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('user-display').innerText = user.email;

        const { data: perfil } = await supabaseClient.from('perfiles_empresa').select('*').eq('id', user.id).single();
        if (perfil) {
            if (user.email === "polojesus1986@gmail.com") {
                document.getElementById('info-consultas').innerText = "Modo: Administrador (Sin límites)";
                document.getElementById('dias-val').innerText = "∞";
                document.getElementById('barra-dias').style.width = "100%";
                return;
            }
            const hoy = new Date(), registro = new Date(perfil.fecha_registro);
            const restantes = Math.max(0, 7 - Math.floor((hoy - registro) / 86400000));
            document.getElementById('dias-val').innerText = `${restantes}/7`;
            document.getElementById('barra-dias').style.width = `${(restantes/7)*100}%`;
            document.getElementById('info-consultas').innerText = `Consultas: ${perfil.consultas_realizadas_hoy}/10`;
        }
    }

    document.getElementById('auth-form').onsubmit = async (e) => {
        e.preventDefault();
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: document.getElementById('auth-email').value,
            password: document.getElementById('auth-password').value
        });
        if (error) alert(error.message); else actualizarUI(data.user);
    };

    async function subirArchivo(input) {
        const formData = new FormData(); formData.append('file', input.files[0]);
        const res = await fetch('/upload', { method: 'POST', body: formData });
        const data = await res.json();
        document.getElementById('upload-zone').innerHTML = "✅ Archivo Analizado";
    }

    document.getElementById('chat-form').onsubmit = async (e) => {
        e.preventDefault();
        const input = document.getElementById('user-input'), query = input.value;
        const chatWin = document.getElementById('chat-window');
        chatWin.innerHTML += `<div class="msg msg-user">${query}</div>`;
        input.value = "";
        const res = await fetch('/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ message: query }) });
        const data = await res.json();
        chatWin.innerHTML += `<div class="msg msg-ai"><strong>AI Pro Analyst:</strong><br>${data.reply.replace(/\n/g, '<br>')}</div>`;
        document.getElementById('download-pdf').style.display = 'block';
        chatWin.scrollTop = chatWin.scrollHeight;
    };

    // FUNCIÓN DE PDF CORREGIDA PARA REPORTE COMPLETO
    // FUNCIÓN DE PDF CORREGIDA (PARA QUE NO SE CORTE EL REPORTE)
    document.getElementById('download-pdf').onclick = async () => {
        const { jsPDF } = window.jspdf;
        const btn = document.getElementById('download-pdf');
        const chatWin = document.getElementById('chat-window');
        
        btn.innerText = "Generando Reporte...";

        // 1. Guardamos el estado original
        const originalHeight = chatWin.style.height;
        const originalOverflow = chatWin.style.overflow;

        // 2. "Estiramos" el contenedor para que se vea TODO el contenido antes de la foto
        chatWin.style.height = 'auto';
        chatWin.style.overflow = 'visible';

        try {
            // 3. CAPTURA TOTAL (Aquí es donde estaba el cambio importante)
            const canvas = await html2canvas(chatWin, { 
                scale: 2, 
                useCORS: true, 
                scrollY: -window.scrollY,
                windowHeight: chatWin.scrollHeight,
                height: chatWin.scrollHeight 
            });

            const doc = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

            // Encabezado profesional azul oscuro
            doc.setFillColor(15, 23, 42); 
            doc.rect(0, 0, 210, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.text("AI PRO ANALYST - REPORTE ESTRATÉGICO", 10, 13);

            // Añadir la imagen capturada
            const imgData = canvas.toDataURL('image/png');
            doc.addImage(imgData, 'PNG', 0, 25, pdfWidth, pdfHeight);
            
            doc.save(`Reporte_AI_Pro_${new Date().getTime()}.pdf`);
        } catch (error) {
            console.error("Error al generar PDF:", error);
            alert("Hubo un error al generar el PDF.");
        } finally {
            // 4. Devolvemos el chat a su tamaño normal con scroll
            chatWin.style.height = originalHeight;
            chatWin.style.overflow = originalOverflow;
            btn.innerHTML = '<i class="fas fa-file-pdf"></i> Descargar Reporte Completo';
        }
    };