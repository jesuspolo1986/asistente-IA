<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>AI Pro Analyst - Business Intelligence</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --accent: #3b82f6; --dark: #0f172a; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); display: flex; height: 100vh; }
        .sidebar { width: 280px; background: white; border-right: 1px solid #e2e8f0; padding: 20px; display: flex; flex-direction: column; }
        .main { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow: hidden; }
        #chat-window { flex: 1; background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 20px; overflow-y: auto; margin-bottom: 20px; }
        .msg { margin-bottom: 15px; padding: 12px; border-radius: 8px; max-width: 80%; }
        .msg-user { align-self: flex-end; background: var(--dark); color: white; margin-left: auto; }
        .msg-ai { align-self: flex-start; background: #f1f5f9; border: 1px solid #e2e8f0; }
        .input-area { display: flex; gap: 10px; background: white; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; }
        input { flex: 1; border: none; outline: none; font-size: 1rem; }
        #chart-box { height: 250px; margin-top: 10px; display: none; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>AI Pro Analyst</h2>
        <div style="margin-top: auto; font-size: 0.8rem; color: #64748b;">Analista: <strong>Jesus M Polo</strong></div>
    </div>
    <div class="main">
        <div id="chat-window">
            <div id="upload-zone" style="text-align: center; border: 2px dashed #cbd5e1; padding: 30px; border-radius: 12px; cursor: pointer;" onclick="document.getElementById('file-input').click()">
                <i class="fas fa-upload" style="font-size: 2rem; color: var(--accent);"></i>
                <p>Sube tu archivo para iniciar el an√°lisis con Mistral AI</p>
            </div>
            <input type="file" id="file-input" style="display:none" onchange="uploadFile(this)">
            <div id="chart-box"><canvas id="canvasIA"></canvas></div>
        </div>
        <form id="chat-form" class="input-area">
            <input type="text" id="user-input" placeholder="Pregunta sobre tus ventas...">
            <button type="submit" style="background:var(--dark); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>

    <script>
        let chartInstance = null;

        async function uploadFile(input) {
            const formData = new FormData();
            formData.append('file', input.files[0]);
            const res = await fetch('/upload', { method: 'POST', body: formData });
            const data = await res.json();
            document.getElementById('upload-zone').innerHTML = `<i class="fas fa-check-circle" style="color:#10b981"></i> ${data.reply}`;
            if(data.chart_data) renderChart(data.chart_data);
        }

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('user-input');
            const msg = input.value;
            if(!msg) return;

            const chatWin = document.getElementById('chat-window');
            chatWin.innerHTML += `<div class="msg msg-user">${msg}</div>`;
            input.value = "";

            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: msg})
            });
            const data = await res.json();
            chatWin.innerHTML += `<div class="msg msg-ai"><strong>AI:</strong> ${data.reply}</div>`;
            if(data.new_chart_data) renderChart(data.new_chart_data);
            chatWin.scrollTop = chatWin.scrollHeight;
        };

        function renderChart(cData) {
            const ctx = document.getElementById('canvasIA').getContext('2d');
            document.getElementById('chart-box').style.display = 'block';
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: cData.labels,
                    datasets: [{ label: cData.title, data: cData.values, backgroundColor: '#3b82f6' }]
                },
                options: { maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>