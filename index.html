<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analista Conversacional de Supermercado</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px;
            background-color: #e9eef2; 
            color: #333; 
        }
        .container { 
            max-width: 900px; 
            margin: auto; 
            background: #ffffff; 
            padding: 40px; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); 
        }
        h1 { 
            color: #007bff; 
            text-align: center; 
            margin-bottom: 10px; 
            font-size: 2.2em;
        }
        h2 {
            color: #555;
            text-align: center;
            font-weight: 300;
            margin-bottom: 30px;
        }
        textarea { 
            width: 100%; 
            padding: 15px; 
            margin-bottom: 10px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            font-size: 16px; 
            resize: vertical; 
            min-height: 120px; 
            box-sizing: border-box; 
            transition: border-color 0.3s;
        }
        textarea:focus {
            border-color: #007bff;
        }
        
        /* Contenedor de botones para incluir el micro */
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        #sendButton { 
            background-color: #28a745; 
            color: white; 
            padding: 15px 25px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 18px; 
            transition: background-color 0.3s, transform 0.2s; 
            flex-grow: 1;
            font-weight: bold;
        }
        
        #btn-micro {
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            width: 60px;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #sendButton:hover { 
            background-color: #218838; 
            transform: translateY(-2px);
        }

        /* Efecto cuando el micro est√° escuchando */
        .recording {
            background-color: #dc3545 !important;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        button:disabled {
            background-color: #90a4ae !important;
            cursor: not-allowed;
        }

        #responseArea { 
            margin-top: 30px; 
            padding: 25px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background-color: #f7f7f7; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            font-size: 1em; 
        }

        /* Estilo para tablas que genera la IA */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #007bff; color: white; }

        .loading { 
            text-align: center; 
            color: #f39c12; 
            font-weight: bold; 
        }
        .success { color: #1e7e34; }
        .error { color: #dc3545; }
        .info { font-size: 0.8em; color: #6c757d; text-align: center; margin-top: 20px; }
        hr { border: 0; border-top: 1px solid #eee; margin: 15px 0; }
    </style>
</head>
<body>

<div class="container">
    <h1>üõí Analista Conversacional de Supermercado</h1>
    <h2>API impulsada por Gemini (Con Voz)</h2>

    <p>Ingresa una pregunta o usa el micr√≥fono para dictar:</p>

    <textarea id="questionInput" placeholder="Ejemplo: ¬øCu√°l es la categor√≠a con m√°s ventas en Bogot√°?"></textarea>

    <div class="button-group">
        <button id="btn-micro" onclick="activarVoz()" title="Hablar">üé§</button>
        <button id="sendButton" onclick="sendQuery()">Analizar Datos con IA</button>
    </div>

    <div id="responseArea">
        <p class="info">La respuesta del analista aparecer√° aqu√≠.</p>
    </div>

    <p class="info">Endpoint Activo: https://asistente-ia-ksrx.onrender.com/api/consulta</p>
</div>

<script>
    const API_ENDPOINT = "https://asistente-ia-ksrx.onrender.com/api/consulta";
    
    const questionInput = document.getElementById('questionInput');
    const responseArea = document.getElementById('responseArea');
    const sendButton = document.getElementById('sendButton');
    const btnMicro = document.getElementById('btn-micro');

    // --- FUNCI√ìN DE VOZ ---
    function activarVoz() {
        const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!Recognition) {
            alert("Tu navegador no soporta el reconocimiento de voz. Usa Google Chrome.");
            return;
        }

        const recognition = new Recognition();
        recognition.lang = 'es-ES';
        recognition.interimResults = false;

        recognition.onstart = () => {
            btnMicro.classList.add('recording');
            btnMicro.innerHTML = "üõë";
            questionInput.placeholder = "Escuchando...";
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            questionInput.value = transcript;
        };

        recognition.onerror = (event) => {
            console.error("Error de reconocimiento:", event.error);
            alert("No se pudo reconocer la voz. Verifica los permisos del micr√≥fono.");
        };

        recognition.onend = () => {
            btnMicro.classList.remove('recording');
            btnMicro.innerHTML = "üé§";
            questionInput.placeholder = "Ejemplo: ¬øCu√°l es la categor√≠a con m√°s ventas en Bogot√°?";
        };

        recognition.start();
    }

    // --- FUNCI√ìN DE ENV√çO (Mantenida igual para asegurar conexi√≥n) ---
    async function sendQuery() {
        const question = questionInput.value.trim();
        
        if (!question) {
            responseArea.innerHTML = '<p class="error">Por favor, escribe o dicta una pregunta antes de analizar.</p>';
            return;
        }

        sendButton.disabled = true;
        responseArea.innerHTML = '<p class="loading">‚è≥ La IA est√° analizando los datos... Por favor, espere.</p>';

        try {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: question })
            });

            const data = await response.json();
            
            if (data.status === 'success' || data.status === 'failed') {
                const headerStatus = data.status === 'success' ? 
                    '<h3 class="success">‚úÖ An√°lisis Exitoso</h3>' : 
                    '<h3 class="error">‚ùå An√°lisis con Advertencias</h3>';

                // Convertimos saltos de l√≠nea en <br> para que se vea bien en el HTML
                const formattedResponse = data.response.replace(/\n/g, '<br>');

                responseArea.innerHTML = `
                    ${headerStatus}
                    <p><strong>Pregunta:</strong> ${data.query}</p>
                    <hr>
                    <div>${formattedResponse}</div>
                `;
            } else {
                responseArea.innerHTML = `<h3 class="error">‚ùå Error</h3><p>${data.error || 'Error desconocido'}</p>`;
            }

        } catch (error) {
            responseArea.innerHTML = `<h3 class="error">‚ùå Error de Conexi√≥n</h3><p>Detalles: ${error.message}</p>`;
        } finally {
            sendButton.disabled = false;
        }
    }
</script>

</body>
</html>